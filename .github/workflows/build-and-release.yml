name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run type check
        run: npm run type-check
        
      - name: Run linting
        run: npm run lint
        
      - name: Run tests
        run: npm test
        
      - name: Build React app
        run: npm run build:react

  build-windows:
    needs: test
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        
              - name: Build Windows executable (portable)
          run: npm run dist:portable
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
        - name: Build Windows directory for ZIP
          run: npm run build && npx electron-builder --win dir --ia32
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
              - name: Create ZIP archive
          run: |
            cd dist-electron
            if (Test-Path "win-unpacked") {
              Compress-Archive -Path "win-unpacked/*" -DestinationPath "MinutesGen-v${{ github.ref_name }}-portable-ia32.zip"
            } else {
              Write-Host "win-unpacked directory not found"
              Get-ChildItem -Recurse
            }
          shell: powershell
        
      - name: Upload Windows Portable
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: dist-electron/*.exe
          
      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: dist-electron/*.zip
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist-electron/
            !dist-electron/node_modules/

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: MinutesGen ${{ github.ref_name }}
          body: |
            ## MinutesGen ${{ github.ref_name }}
            
            ### ğŸ¯ æ–°æ©Ÿèƒ½ãƒ»æ”¹å–„
            - AIè­°äº‹éŒ²ç”Ÿæˆæ©Ÿèƒ½ã®æ”¹å–„
            - ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé¢¨éŸ³å£°ç”Ÿæˆæ©Ÿèƒ½
            - Wordæ–‡æ›¸ï¼ˆdocxï¼‰å¯¾å¿œ
            - æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å¯¾å¿œå¼·åŒ–
            
            ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            - **MinutesGen-v${{ github.ref_name }}-portable.exe**: å˜ä½“å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ¨å¥¨ï¼‰
            - **MinutesGen-v${{ github.ref_name }}-portable-ia32.zip**: ãƒãƒ¼ã‚¿ãƒ–ãƒ«ç‰ˆï¼ˆZIPå½¢å¼ï¼‰
            
            ### ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
            - Windows 10/11 (32-bit/64-bit)
            - ãƒ¡ãƒ¢ãƒª: 4GBä»¥ä¸Šæ¨å¥¨
            - ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡: 500MBä»¥ä¸Š
            
            ### ğŸ“‹ ä½¿ç”¨æ–¹æ³•
            1. å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. åˆå›èµ·å‹•æ™‚ã«API KEYã‚’è¨­å®š
            3. éŸ³å£°ãƒ»å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            4. AIå‡¦ç†ã§è­°äº‹éŒ²ã‚’è‡ªå‹•ç”Ÿæˆ
            
            è©³ç´°ãªä½¿ç”¨æ–¹æ³•ã¯[README.md](https://github.com/${{ github.repository }}/blob/main/README.md)ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
          draft: false
          prerelease: false
          
      - name: Upload Release Assets
        run: |
          for file in artifacts/windows-portable/*.exe; do
            if [ -f "$file" ]; then
              gh release upload ${{ github.ref_name }} "$file"
            fi
          done
          
          for file in artifacts/windows-zip/*.zip; do
            if [ -f "$file" ]; then
              gh release upload ${{ github.ref_name }} "$file"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 